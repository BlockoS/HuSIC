//// HuSIC  ///////////////////////
//  A Sound Driver for PC Engine
//  ver 0.40 Programmed by BouKiCHi
///////////////////////////////////

■HuSICについて

　HuSICとはPCエンジンのための音源ドライバです。
　波形音源による独特の音で楽曲を作成、楽しむことができます。
　HuSICの使用規約に関しては、当ドキュメントの該当項目を参照ください。


 ■使用方法( Usage )

　音源ルーチンとデータだけを取り出したHES形式と
　エミュレータや実機などで動作するイメージであるPCE形式の出力ができます。


・HESの作成
　songsフォルダにmmlファイルを置いてmake_hesを
　以下のように実行することで生成されます。
　>make_hes yoursong
   (yoursongは拡張子を含めないmmlファイル名)

・PCEの作成
　rommakeフォルダにmmlファイルを置いてmake_pceを
　以下のように実行することで生成されます。
　>make_pce yoursong
   (yoursongは拡張子を含めないmmlファイル名)


 ■機能( Feature )

　・0chから5chまでの6ch
　・ステレオパン
　・ソフトウェアボリュームエンベロープ
　・波形変更
　・ノイズモード(ハードの仕様により4,5ch固定)


 ■HuSIC拡張コマンド( HuSIC exclusive command )

　△$f2,スイッチ

　スイッチ= $00 = ノイズオフ
　スイッチ= $01 = ノイズオン

　ノイズの場合はオクターブが無効になる。（下位4bitが有効）
　また、ハードウェア的制限により4chと5chのみ有効となる。

  △$f1,波形番号

　テーブルから波形をセットする。
　波形番号はテーブルの位置を意味し、エンベロープデータなどと
　同じ方式で格納されている。

　△$f0,パンボリューム

　チャンネル別のボリュームを設定する。
　上位4ビット=左ch , 下位4ビット=右ch
　0 = 最低 , 15 = 最高

  △$ef,XPCM

  XPCM=1でXPCMモード、4ch,5ch使用

  △$ee,バンク番号,アドレス(下位8bit),アドレス(上位8bit)

　シーケンスデータの存在するバンクを切り替える。

  △$ed,モード
	LFOモードの設定。(255でLFO停止)
	0 = LFO無し
	1 = トラックA + 変調データ
	2 = トラックA + 変調データ * 16(4bit左シフト)
	3 = トラックA + 変調データ * 256(8bit左シフト)

	変調データはトラックBの波形データが使用されます。
	その場合、波形データはsigned 5bitの数値として扱われます。

	※LFO有効時はトラックBがミュートされます。

  △$ec,LFO周波数

	周波数 = 3.58MHz / (32 * トラックB周波数 * LFO周波数)

  △$e9

  スラーコマンド

  △$eb, porthi, portlo

  porthi: 1フレームごとに周波数レジスタに増減される値(符号付き)
  portlo: 1/128カウンタ(0x80以上でオーバーフロー時に1減算)

  △$e8, mvol

  mvol: マスターボリューム($801)設定値

  △$e7, rst

  rsi: リセット無視フラグ設定値

  △$e6, panenv

  panenv: パンエンベロープ

 ■バンク切り替え時の注意点( Attention )

 　バンクを超えてリピートコマンドを使用することは出来ません。

 　
 ■動作未確認機能 ( Untested Feature )

　isomakeディレクトリにあるバッチファイルでCDイメージが作成できます。
　ただし、メモリマップが異なるため、正しく動作しない可能性があります。


 ■既知の問題点 ( Known Problems )

　一つのトラックにLのみを書くとドライバ全体が止まる。(MMLコンパイラ側の不具合)
　漢字コードがおかしい。


 ■履歴( History )

 ver 0.01 2004/02/29-
　とりあえず突貫工事の末に基本部分を作る。
　HuCは漢字コメントが使えないらしいという所で、
　しばらく時間が掛かった。

 ver 0.02 2004/03/10
  コンパイラをHuC 3.20に変更。
　音程が間違っていたのを修正ｗ
　データの読み込み方法を変更。
　ボリュームコマンドを有効に。

 ver 0.03 2004/03/11
  6ch化。
  ソフトウェアボリュームエンベロープコマンドを追加。
　下記の拡張コマンドを追加。
　$F2コマンド（ノイズ設定コマンド）　4,5chにて有効。
  $F1コマンド（波形変更コマンド）  全チャンネルで有効。

 ver 0.04 2004/03/13
  音程が半音上がっていたのを修正。
　波形初期化ルーチンの修正。

 ver 0.05 2004/03/14
  ピッチエンベロープコマンド、
　ディチューンコマンドの追加。

 ver 0.06 2004/03/15
　ボリュームコントロールの方法を変更。
　拡張パンコマンド($F0)を追加。

 ver 0.07 2004/03/23
  リピートコマンドを追加。($A0,$A1)

 ver 0.08 2004/04/06
　ボリューム最大値を15から31に変更。
　pcewave.hを削除。pce_data_tableへ名前を変更。

 ver 0.08a 2004/04/09
　MPコマンドを暫定的に追加。

 ver 0.08b 2004/04/10
  ノイズコマンドオフ時に波形モードに戻すようにした。

 ver 0.09  2004/04/13
　ノイズ周波数のレンジを広げた（00h-1Fhまで）
　ノイズをピッチエンベロープに対応させた。
　XPCM(タイマー駆動によるDirectD/Aを使用したPCM機能)を搭載
  (第6ch使用。$ef=1でオン)
　ドライバの処理をVSYNC割り込みで行うようにした。

 ver 0.10  2004/04/17
　$EEコマンド（バンク切り替え）を追加。
　書式は$EE,バンク,次のシーケンスデータ
　上記の改造に伴い、曲データポインタにもバンク番号を求めるようにした。
　HES作成時におけるDATA構造体サイズ計算方法の改善

 ver 0.10(without XPCM) 2004/05/05
  処理速度が一定に満たない（or PCMに対応していない)システム用のテスト。

 ver 0.11  2004/05/27
　LFO機能を追加。
　周波数テーブルを16個に削減。

 ver 0.12  2004/05/28
　周波数テーブルを１オクターブ下げた。

 ver 0.12a 2004/10/19
　バンク切り替え時に音色を含めたデータ領域への
アクセスが出来なくなる不具合を修正。

 ver 0.13  2004/10/23
　0.12aの修正を別の部分にも適用。

 ver 0.14  2005/01/19
  LFOトリガーが動作しないという部分を修正しました。

 ver 0.14a 2005/07/14
　各バッチでppmckc.exeを利用するようにした。
  make.batを作成し、特定のファイル名に依存しないコンパイルが可能になった。
  PCE_INCLUDEをバッチ内部で定義することにした。
  clean.bat、make_hes_nc.batを作成した。

 ver 0.20  2005/09/08
　PCMタイマーの設定や、ジャンプテーブル使用などによる各種高速化を行った。

 ver 0.21 2006/03/05
　ドキュメントを更新。お約束の項を廃止、使用規約の項を新設。
　hus_hes.s（プログラム本体）の更新
　ノートエンベロープ機能を追加

 ver 0.22 2006/03/11
　ノートエンベロープの修正

 ver 0.23 2006/03/16
  ノートエンベロープのマイナス値に対する挙動を修正

  ver 0.24 2007/04/11
  ファイルの整理、ソフトウェアLFOを再度有効化

  ver 0.25 2007/04/16
  曲ファイルの挿入をhmckc -iによるファイル名指定にした。
  XPCMが正しく再生できないバグを修正。

  ver 0.26 2007/04/21
  XPCMのキーオフに関するバグを修正。
  リピートコマンド($a0)をppmckc仕様に変更。（異なるバンクでのリピートが可能）

  ver 0.30alpha 2011/12/11
  UTF8で日本語のコメントを記述するようにした。
  HuSICのソースコードを調整。
  XPCMを2ch同時に再生できるようにした。(トラックEFが利用可能)
  各スクリプトを調整した。
  フォルダ構成を変更し、パッケージをひとまとめにした。

  ver 0.30alpha2 2011/12/16
  XPCMをアセンブラで実装した。
  Makefile、ソースコードを調整。
  スクリプトの修正。

  ver 0.30alpha3 2011/12/17
  CD関連のバッチ、スクリプト関連の変更によりcueファイルを出力するようにした。
  トラックがLコマンドのみの場合フリーズしてしまう問題を対策をした。
  デバッグ用のウェイトを除去した。

  ver 0.30 2012/08/13
  XPCMのCh.Eが正しく再生出来なかった問題を修正
  wav2pd4が一部WAVファイルを読めなかった問題を修正
  auto-bankswitchが正しく機能しなかった問題を修正

  ver 0.31 2015/05/22
  HuCを64bit環境でコンパイルが通るように修正
  HuCでコメント部分が正しく処理されない問題を修正
  @@コマンドを有効にした
  HuSIC本体をわずかに最適化

  ver 0.32 2015/09/09
  バンク切替時の問題を修正

  ver 0.33 2015/09/12
  スラーを追加した

  ver 0.34 2015/09/14
  ポルタメントを追加した

  ver 0.35 2015/09/14
  ポルタメントの挙動を修正した

  ver 0.36 2015/09/24
  トーンエンベロープの修正
  波形変更時の音量設定の調整
  音量コマンド発行位置の調整

  ver 0.37 2015/09/25
  トーンエンベロープのデータで扱うことができる数値を0-255に修正
  トーンエンベロープが前回と同じ音色の際には波形を変更しないように修正
  マスターボリュームの変更コマンドMVの追加

  ver 0.38 2015/09/26
  qコマンドがスラー使用時に最後のノートのみに有効になるように挙動を修正。

  ver 0.39 2015/10/05
  ドキュメントの追加
  エンベロープ定義でx<num>を利用可能にした
  (10 x4で10を4回繰り返すのと同じになる)
  RI(リセット無視)、@pe(パンエンベロープ)コマンドを追加した
  @ME定義の追加

  ver 0.40 2015/10/05
  isomake関連の修正



 ■HuSIC使用規約 Ver 1.0(2006/03/05)
　HuC/PCEASの部分に関してはHuCの使用許諾に従う必要があります。
　それ以外の部分に関しては以下の項目すべてに同意される場合のみに使用可能です。

　・当プログラムを使用した結果として発生するすべての現象に関して作者、
　　並びに配布者は一切の責任を負いません。個人の責任においてのみ使用できます。
　・使用、改造、組み込みは他のすべての使用規約に従う場合のみ、無償かつ自由に行うことが出来ます。
　・当アーカイブに含まれるファイルを変更しソース状態のまま再配布する場合、
　　変更された点に関する情報を明記し、アーカイブに同梱してください。
　・ソース状態での配布では、この使用規約を含めたドキュメントを同梱する必要があります。
　・バイナリ状態での配布では、他のすべての使用規約に従う場合のみ自由に
　　ファイル、またはアーカイブを構成することができます。
